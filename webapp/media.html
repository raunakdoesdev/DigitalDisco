<script src="https://webtiming.github.io/timingsrc/lib/timingsrc-v2.js" text="javascript"></script>
<script src="https://www.mcorp.no/lib/mcorp-2.0.js" text="javascript"></script>
<script src="https://www.mcorp.no/lib/mediasync.js" text="javascript"></script>

<div id="demo" style="height:50px">
    <p id='buttons'>
        <button id='tostart'>Reset</button>
        <button id='pause'>Pause</button>
        <b>
            <button id='forward'>Play</button>
        </b>
        <!--        <button id='skipbackward'>Skip 5 Back</button>-->
        <!--        <button id='skipforward'>Skip 5 Ahead</button>-->

    </p>
    <p>
        <b><span id='position'></span></b>
    </p>

</div>
<audio controls id="player1" style="width:100%" autoplay>
    <source id="audiosource" src="SONGPATHHERE" type="audio/mpeg"/>
</audio>

<script type="text/javascript">
    var m, w;
    let to;

    var run = function () {

        // timing object
        var to = new TIMINGSRC.TimingObject({range: [0, 100]});

        var mcorp_app = MCorp.app("8711565362037307822", {anon: true});

        mcorp_app.ready.then(function () {
            to.timingsrc = mcorp_app.motions["MOTION_NAME_HERE"];
        });

        console.log("Hello World!", to.query())

        placeholder_fn = function () {
        };

        // set up button click handlers
        var buttonsElem = document.getElementById("buttons");
        var self = this;
        buttonsElem.onclick = function (e) {
            var elem, evt = e ? e : event;
            if (evt.srcElement) elem = evt.srcElement;
            else if (evt.target) elem = evt.target;
            if (elem.id === "pause") {
                to.update({velocity: 0.0});
                httpGetAsync(`https://608dev-2.net/sandbox/sc/team00/final/comm.py?reason=pause&room=ROOMGOESHERE`)
            } else if (elem.id === "tostart") {
                to.update({position: 0.0, velocity: 0.0});
                httpGetAsync(`https://608dev-2.net/sandbox/sc/team00/final/comm.py?reason=pause&room=ROOMGOESHERE`)
            } else if (elem.id === "forward") {
                to.update({velocity: 1.0});
                httpGetAsync(`https://608dev-2.net/sandbox/sc/team00/final/comm.py?reason=play&room=ROOMGOESHERE&position=${to.query().position}`)
            }
        };

        // set up refresh of timingobject position
        to.on("timeupdate", function () {
            document.getElementById("position").innerHTML = to.query().position.toFixed(2);
        });

        // set up video sync
        var sync1 = MCorp.mediaSync(document.getElementById('player1'), to);

        if (to.query().velocity < 0.1) {
            httpGetAsync(`https://608dev-2.net/sandbox/sc/team00/final/comm.py?reason=pause&room=ROOMGOESHERE`)
        } else {
            httpGetAsync(`https://608dev-2.net/sandbox/sc/team00/final/comm.py?reason=play&room=ROOMGOESHERE&position=${to.query().position}`)
        }

    };

    run();

    function httpGetAsync(theUrl, process = false) {
        var xmlHttp = new XMLHttpRequest();
        if (process) {
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                    var audio = document.getElementById('player1')
                    var audio_src = document.getElementById("audiosource");
                    if (audio_src.getAttribute('src') !== xmlHttp.responseText) {
                        audio_src.setAttribute('src', xmlHttp.responseText);
                        audio.load();
                        audio.play();
                    }
                }
            };
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.send(null);
    }

    setInterval(function () {
        httpGetAsync('https://608dev-2.net/sandbox/sc/team00/final/comm.py?reason=jsquery&room=ROOMGOESHERE', true);
    }, 1000);

</script>